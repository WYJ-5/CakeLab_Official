<%- include('../partials/head', { title: 'å¾Œå°ç®¡ç† - è¨‚å–®è³‡æ–™ç¶­è­·' }) %>
<style>
    /* çµ±ä¸€å…¨å¾Œå°ä½ˆå±€æ¨£å¼ - ç¢ºä¿èˆ‡ products.ejs å®Œã€‚å…¨ã€‚ä¸€è‡´ */
    :root { --sidebar-width: 250px; --primary-color: #8b5e3c; }
    body { margin: 0; background: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
    
    /* é—œéµï¼šé€™è£¡ä¹Ÿè¦ç¢ºä¿é¡åˆ¥åç¨±ç‚º admin-wrapper ä¸” display: flex */
    .admin-wrapper { display: flex; min-height: 100vh; }
    
    .sidebar { width: var(--sidebar-width); background: #333; color: white; padding: 30px 0; flex-shrink: 0; display: flex; flex-direction: column; }
    .sidebar-header { padding: 0 25px 20px; border-bottom: 1px solid #444; margin-bottom: 20px; text-align: center; }
    .sidebar-header h3 { margin: 0; font-size: 1.2rem; color: white; }
    
    .nav-item { display: flex; align-items: center; padding: 12px 25px; color: #bbb; text-decoration: none; transition: 0.3s; }
    .nav-item:hover { color: white; background: #444; }
    .nav-item.active { color: white; background: #444; border-left: 4px solid var(--primary-color); }
    .logout-btn { margin-top: auto; color: #ff7675; }

    /* ä»¥ä¸‹ç¶­æŒè¨‚å–®é åŸæœ¬çš„å³å´æ¨£å¼ï¼Œä¸æ›´å‹• */
    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th { text-align: left; padding: 15px; color: #888; border-bottom: 2px solid #f4f4f4; }
    .admin-table td { padding: 15px; border-bottom: 1px solid #f4f4f4; font-size: 0.95rem; }
    .btn-edit { color: #8b5e3c; border: none; background: none; cursor: pointer; font-weight: bold; margin-right: 15px; }
    .btn-delete { color: #e74c3c; border: none; background: none; cursor: pointer; font-weight: bold; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: white; width: 450px; padding: 30px; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); }
    .modal-content label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem; }
    .modal-content input, .modal-content textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
</style>

<div class="admin-wrapper">
    <nav class="sidebar">
        <div class="sidebar-header"><h3>Cake Lab å¾Œå°</h3></div>
        <a href="/admin/products" class="nav-item">ğŸ° å•†å“ç®¡ç†</a>
        <a href="/admin/orders" class="nav-item active">ğŸ“‹ è¨‚å–®ç®¡ç†</a>
        <a href="/" class="nav-item">ğŸ  å›åˆ°é¦–é </a>
        <a href="/admin/logout" class="nav-item ">ğŸšª ç™»å‡ºç³»çµ±</a>
    </nav>

    <main class="main-content">
        <h2 style="margin-bottom: 30px;">è¨‚å–®è³‡æ–™ç¶­è­·</h2>
        <div class="card">
            <table class="admin-table">
                <thead>
                    <tr><th width="60px">ID</th><th>è¨‚è³¼äºº</th><th>é›»è©±</th><th>å–è²¨æ—¥æœŸ</th><th>å“é …å…§å®¹</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody id="adminOrderTable"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
    let allOrders = [];
    window.onload = loadAllOrders;

    async function loadAllOrders() {
        try {
            const res = await fetch('/api/admin/orders');
            if (res.status === 401) return window.location.href = '/admin/login';
            allOrders = await res.json();
            const tbody = document.getElementById('adminOrderTable');
            tbody.innerHTML = allOrders.map(order => `
                <tr>
                    <td style="font-weight:bold;">#${order.id}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.phone}</td>
                    <td style="color:#8b5e3c; font-weight:bold;">${order.pickup_date}</td>
                    <td style="font-size:0.85rem; max-width:250px;">${order.cake_item_string}</td>
                    <td style="color:#888;">${order.notes || '-'}</td>
                    <td>
                        <button class="btn-edit" onclick="openEditModal(${order.id})">ä¿®æ”¹</button>
                        <button class="btn-delete" onclick="deleteOrder(${order.id})">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) { console.error('è¼‰å…¥å¤±æ•—:', err); }
    }

    function openEditModal(id) {
        const order = allOrders.find(o => o.id === id);
        if (order) {
            document.getElementById('editId').value = order.id;
            document.getElementById('editName').value = order.customer_name;
            document.getElementById('editPhone').value = order.phone;
            document.getElementById('editDate').value = order.pickup_date;
            document.getElementById('editNotes').value = order.notes || '';
            document.getElementById('editModal').style.display = 'flex';
        }
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    async function submitEdit() {
        const id = document.getElementById('editId').value;
        const data = {
            customer_name: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            pickup_date: document.getElementById('editDate').value,
            notes: document.getElementById('editNotes').value
        };

        try {
            const res = await fetch('/api/admin/orders/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('ğŸ‰ è¨‚å–®è³‡æ–™å·²æ›´æ–°æˆåŠŸï¼');
                closeModal();
                loadAllOrders();
            } else if (res.status === 401) {
                alert('ç™»å…¥å·²é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
                window.location.href = '/admin/login';
            } else {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹');
            }
        } catch (err) { alert('ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•é€£ç·š'); }
    }

    async function deleteOrder(id) {
        if (!confirm('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) return;
        try {
            const res = await fetch('/api/admin/orders/' + id, { method: 'DELETE' });
            if (res.ok) { alert('è¨‚å–®å·²ç§»é™¤'); loadAllOrders(); }
        } catch (err) { alert('åˆªé™¤å¤±æ•—'); }
    }
</script>
<%- include('../partials/footer') %>